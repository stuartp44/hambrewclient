name: PR Preview Release

on:
  pull_request:
    types: [labeled, opened, synchronize]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  preview-release:
    # Only run if PR has 'preview-release' label or comment contains '/preview-release'
    if: |
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'preview-release')) ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request && 
       contains(github.event.comment.body, '/preview-release'))
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let pr;
            if (context.eventName === 'pull_request') {
              pr = context.payload.pull_request;
            } else {
              // Get PR from issue comment
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              const prNumber = context.issue.number;
              const prData = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              pr = prData.data;
            }
            
            core.setOutput('number', pr.number);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('title', pr.title);
            return pr;

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_sha }}
          fetch-depth: 0

      - name: Generate preview version
        id: version
        run: |
          # Get current version from manifest
          CURRENT_VERSION=$(python -c "import json; print(json.load(open('custom_components/minibrew/manifest.json'))['version'])")
          
          # Create preview version: current-version-preview.pr-number.short-sha
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          SHORT_SHA="${{ steps.pr.outputs.head_sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          
          PREVIEW_VERSION="${CURRENT_VERSION}-preview.${PR_NUMBER}.${SHORT_SHA}"
          
          echo "version=${PREVIEW_VERSION}" >> $GITHUB_OUTPUT
          echo "Preview version: ${PREVIEW_VERSION}"

      - name: Update manifest version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          python -c "
          import json
          with open('custom_components/minibrew/manifest.json', 'r+') as f:
              data = json.load(f)
              data['version'] = '${VERSION}'
              f.seek(0)
              json.dump(data, f, indent=2)
              f.truncate()
          "

      - name: Generate changelog
        id: changelog
        run: |
          PR_TITLE="${{ steps.pr.outputs.title }}"
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          PR_BRANCH="${{ steps.pr.outputs.head_ref }}"
          
          # Get commits in this PR
          git log origin/main..HEAD --pretty=format:"- %s (%h)" --no-merges > commits.txt
          
          # Get contributors in this PR
          CONTRIBUTORS=$(git log origin/main..HEAD --pretty=format:"%an" --no-merges | sort -u)
          
          # Build changelog
          cat > changelog.md << EOF
          ## Preview Release from PR #${PR_NUMBER}
          
          **PR Title:** ${PR_TITLE}
          **Branch:** ${PR_BRANCH}
          
          ### Changes in this Preview
          
          $(cat commits.txt)
          
          ### Contributors
          
          $(echo "$CONTRIBUTORS" | while read -r contributor; do echo "- $contributor"; done)
          
          ---
          
          **WARNING: This is a preview release for testing purposes only.**
          
          **To test this preview:**
          1. Download the release assets
          2. Extract to your Home Assistant \`custom_components\` directory
          3. Restart Home Assistant
          4. Test the changes
          5. Report back on PR #${PR_NUMBER}
          
          **Do not use in production!**
          EOF
          
          cat changelog.md

      - name: Create archive
        run: |
          mkdir -p release
          cp -r custom_components/minibrew release/
          cd release
          zip -r ../minibrew-${{ steps.version.outputs.version }}.zip minibrew/

      - name: Create draft release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Preview ${{ steps.version.outputs.version }} (PR #${{ steps.pr.outputs.number }})
          body_path: changelog.md
          draft: true
          prerelease: true
          files: |
            minibrew-${{ steps.version.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const releaseUrl = '${{ steps.create_release.outputs.url }}';
            const version = '${{ steps.version.outputs.version }}';
            
            const comment = `## Preview Release Created
            
            A preview release has been created for testing this PR.
            
            **Version:** \`${version}\`
            **Release:** ${releaseUrl}
            
            ### How to Test
            
            1. Go to the [draft release](${releaseUrl})
            2. Download \`minibrew-${version}.zip\`
            3. Extract to your Home Assistant \`custom_components\` directory
            4. Restart Home Assistant
            5. Test the changes and report back here
            
            ### Or install directly via HACS:
            \`\`\`
            # Add custom repository in HACS:
            https://github.com/${{ github.repository }}
            
            # Then select version: ${version}
            \`\`\`
            
            ---
            
            **WARNING: This is a preview release - do not use in production!**
            
            Once testing is complete and approved, this PR can be merged for an official release.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: comment
            });

      - name: Add preview-released label
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              labels: ['preview-released']
            });
